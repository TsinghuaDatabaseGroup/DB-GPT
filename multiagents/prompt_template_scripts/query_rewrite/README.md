# DB-GPT for Query Rewrite

## Methods
### 1. APE
We generate the instruction from a small number of collected samples (splitting into training and evaluation sets), i.e., deriving several instructions using the LLM on training set and choosing the best instruction by evaluating on evaluation set. e.g.,

Prompt:
```
Instruction: Rewrite the input SQL query to produce an equivalent query that can be executed on a PostgreSQL database with decreased latency.

Input: select * from ma_apply_detail_info where sku_id>(select max(sku) from ma_inventory_detail where exists(select * from ma_apply_detail_info where ma_inventory_detail.store_id=ma_apply_detail_info.id));
```

LLM "text-davinci-003" Output (replacing exists subquery with join operator):
```
select * from ma_apply_detail_info where sku_id > (select max(sku) from ma_inventory_detail md join ma_apply_detail_info mad on md.store_id=mad.id);
```

## Run
An example of the script for this task is shown in `run.sh`.

The result is like:

| Accuracy | Normalized Rewrite Latency  | Rewrite Latency	  | Input Latency  | Answer Latency  | Prompt  |
| -------- | ------------------ | ---------------- | ---------------------- | -------------------- | -------------------- |
| 1.0 | 0.9016684358515182 | 18.54567 | 20.568167 | 12.51508 | Rewrite the input SQL query to produce an equivalent query that can be executed on a PostgreSQL database with decreased latency.|

where normalized rewrite latency denotes $\frac{Rewrite\ Latency}{Input\ latency}$. The column "Prompt" is the instruction generated by APE, and others are evaluated metrics.
